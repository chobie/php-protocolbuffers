# CMake build script for protoc-gen-php project
#
# Building (out of source build):
# > mkdir build && cd build
# > cmake .. [-DSETTINGS=VALUE]
# > cmake --build .
#
# Testing:
# > ctest -V
#
# Install:
# > cmake --build . --target install

PROJECT(protoc-gen-php)
CMAKE_MINIMUM_REQUIRED(VERSION 2.8)

SET(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}/cmake/modules/")

IF(CMAKE_VERSION VERSION_LESS 2.8.5)
  IF(NOT DEFINED CMAKE_INSTALL_INCLUDEDIR)
    SET(CMAKE_INSTALL_INCLUDEDIR "include" CACHE PATH "C header files (include)")
  ENDIF()

  IF(NOT DEFINED CMAKE_INSTALL_BINDIR)
    set(CMAKE_INSTALL_BINDIR "bin" CACHE PATH "user executables (bin)")
  ENDIF()
ELSE()
  INCLUDE(GNUInstallDirs)
ENDIF()

FIND_PACKAGE(CPPLINT)
FIND_PACKAGE(GTEST)

CONFIGURE_FILE(php_options.proto php_options.proto COPYONLY)
FILE(GLOB SRC_PHP_LINT google/protobuf/compiler/php/*.cc google/protobuf/compiler/php/*.h)
FILE(GLOB SRC_PHP_GEN google/protobuf/compiler/php/*.cc google/protobuf/stubs/*.cc)

INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR})
INCLUDE_DIRECTORIES(${GTEST_ROOT}/include)

CPPLINT(lint "${SRC_PHP_LINT}" protoc-gen-php)
ADD_EXECUTABLE(protoc-gen-php main.cc ${SRC_PHP_GEN} ${PHP_OPTIONS_SRCS})
TARGET_LINK_LIBRARIES(protoc-gen-php ${PROTOBUF_LIBRARIES})
TARGET_LINK_LIBRARIES(protoc-gen-php ${PROTOBUF_PROTOC_LIBRARY})


ADD_EXECUTABLE(unittest
	tests/unittest.cc ${SRC_PHP_GEN} ${PHP_OPTIONS_SRCS}
)

TARGET_LINK_LIBRARIES(unittest
    pthread
    ${GTEST_ROOT}/build/libgtest.a
    ${GTEST_ROOT}/build/libgtest_main.a
    ${PROTOBUF_LIBRARY}
    ${PROTOBUF_PROTOC_LIBRARY}
)

ENABLE_TESTING()
ADD_TEST(unittest unittest)

INSTALL(TARGETS protoc-gen-php DESTINATION ${CMAKE_INSTALL_BINDIR})
INSTALL(FILES php_options.proto DESTINATION ${CMAKE_INSTALL_INCLUDEDIR})


